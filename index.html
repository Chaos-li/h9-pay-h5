<!DOCTYPE html>
<html>
<head>
  <title>高炉家·徽酒集团植树环保行动</title>
  <meta name="description" content="共建最美酒厂，最美高炉">
  <meta charset="utf-8">
  <meta name="apple-touch-fullscreen" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="./css/bootstrap.min.css">
  <link rel="stylesheet" href="./css/style.css">
</head>
<body>
    <div class="form-wrapper">
      <div class="content">
        <!-- 个人表单提交 -->
        <form class="formData form1" data-toggle="validator" role="form" method="post">
          <input type="hidden" name="openid" class="J_openId">
          <div class="form-group">
            <label for="">捐赠人 <span class="red">*</span></label>
            <input class="form-control" placeholder="" name="donor" required>
            <div class="help-block with-errors"></div>
          </div>
          <div class="form-group">
            <label for="">个人捐赠金额 <span class="red">*</span></label>
            <input class="form-control" type="number" min="1000" name="personalAmount" placeholder="" required>
            <div class="help-block with-errors"></div>
          </div>
          <div class="form-group">
            <label for="">个人联系方式 <span class="red">*</span></label>
            <input type="text" class="form-control" placeholder="" name="personalMobile" pattern="^1[3|4|5|7|8][0-9]\d{4,8}$"  data-error="请输入正确的手机号码" required>
            <div class="help-block with-errors"></div>
          </div>
          <div class="text-center">
            <button class="btn btn-success text-center J_submit" type="submit">提交</button>
          </div>
        </form>

        <!-- 企业表单提交 -->
        <form class="formData form2" data-toggle="validator" role="form" method="post">
          <input type="hidden" name="openid" class="J_openId">
          <div class="form-group">
            <label for="company">捐赠企业 <span class="red">*</span></label>
            <input type="text" class="form-control inputxt" id="company" name="enterprise" required data-error="">
            <div class="help-block with-errors"></div>
          </div>
          <div class="form-group">
            <label for="">企业捐赠金额 <span class="red">*</span></label>
            <input class="form-control" type="number" min="5000" name="enterpriseAmount" placeholder="" data-error="" required>
            <div class="help-block with-errors"></div>
          </div>
          <div class="form-group">
            <label for="">企业联系方式 <span class="red">*</span></label>
            <input type="text" class="form-control" placeholder="" name="enterpriseMobile" pattern="^1[3|4|5|7|8][0-9]\d{4,8}$"  data-error="请输入正确的手机号码" required>
            <div class="help-block with-errors"></div>
          </div>
          <div class="text-center">
            <button class="btn btn-success text-center J_submit" type="submit">提交</button>
          </div>
        </form>

        <!-- 个人企业表单提交 -->
        <form class="formData form3" data-toggle="validator" role="form" method="post">
          <input type="hidden" name="openid" class="J_openId">
          <div class="form-group">
            <label for="company">捐赠企业 <span class="red">*</span></label>
            <input type="text" class="form-control inputxt" id="company" name="enterprise" required data-error="">
            <div class="help-block with-errors"></div>
          </div>
          <div class="form-group">
            <label for="">企业捐赠金额 <span class="red">*</span></label>
            <input type="number" min="5000" class="form-control" name="enterpriseAmount" placeholder="" data-error="" required>
            <div class="help-block with-errors"></div>
          </div>
          <div class="form-group">
            <label for="">企业联系方式 <span class="red">*</span></label>
            <input type="text" class="form-control" placeholder="" name="enterpriseMobile" pattern="^1[3|4|5|7|8][0-9]\d{4,8}$"  data-error="请输入正确的手机号码" required>
            <div class="help-block with-errors"></div>
          </div>
          <div class="form-group">
            <label for="">捐赠人 <span class="red">*</span></label>
            <input class="form-control" placeholder="" name="donor" required>
            <div class="help-block with-errors"></div>
          </div>
          <div class="form-group">
            <label for="">个人捐赠金额 <span class="red">*</span></label>
            <input type="number" min="0.01" class="form-control" name="personalAmount" placeholder="" required>
            <div class="help-block with-errors"></div>
          </div>
          <div class="form-group">
            <label for="">个人联系方式 <span class="red">*</span></label>
            <input type="text" class="form-control" placeholder="" name="personalMobile" pattern="^1[3|4|5|7|8][0-9]\d{4,8}$"  data-error="请输入正确的手机号码" required>
            <div class="help-block with-errors"></div>
          </div>
          <div class="text-center">
            <button class="btn btn-success text-center J_submit" type="submit">提交</button>
          </div>
        </form>
      </div>

      <!-- <div class="mark-wraper">
        <span>正在提交...</span>
      </div> -->
    </div>
</body>
<script type="text/javascript" src="./js/jquery.min.js"></script>
<script type="text/javascript" src="./js/validator.min.js"></script>
<script type="text/javascript" src="./js/common.js"></script>
<script type="text/javascript">
  var url = "https://donate-dev-h9.thy360.com"
  $(function() {
    var openId = getQueryString("openid");
    var type = getQueryString("type");
    if(type == 3) {
      $(".form3").show();
    } else if (type == 2) {
      $(".form2").show();
    } else {
      $(".form1").show();
    }
    $(".J_openId").val(openId);


    // 表单提交
    $(".formData").validator().on('submit', function(e) {
      if( e.isDefaultPrevented()) {
        return false;
      } else {
        e.preventDefault();
        $(".J_submit").html("正在提交...")
        var datas = $(".form" + type).serializeObject();
        $.ajax({
          type: 'POST',
          url: url + '/h9/pay/donate/pay/submit',
          contentType: 'application/json;charset=UTF-8',
          dataType: 'json',
          data: JSON.stringify(datas),
          success: function(data) {
            $(".J_submit").html("提交")
            if(data.statusCode == 0) {
              // 调起微信支付
              function onBridgeReady(){
                 WeixinJSBridge.invoke(
                     'getBrandWCPayRequest', {
                         "appId": data.data.appId,     //公众号名称，由商户传入
                         "timeStamp":data.data.timestamp,         //时间戳，自1970年以来的秒数
                         "nonceStr":data.data.nonceStr, //随机串
                         "package":data.data.packageParam,
                         "signType":data.data.signType,         //微信签名方式：
                         "paySign":data.data.paySign //微信签名
                     },
                     function(res){
                         if(res.err_msg == "get_brand_wcpay_request:ok" ) {
                          location.href = "./success.html?timestamp2="+ (new Date()).getTime();
                         }else {
                          console.log("支付失败。。")
                         }
                     }
                 );
              }
              if (typeof WeixinJSBridge == "undefined"){
                 if( document.addEventListener ){
                     document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
                 }else if (document.attachEvent){
                     document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
                     document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
                 }
              }else{
                 onBridgeReady();
              }

            } else {
              console.log(data.msg)
            }
          }
        })
        return false;
      }
    })

    // 表单序列化为JSON对象
    $.fn.serializeObject = function() {
      var o = {};
      var a = this.serializeArray();
      $.each(a, function() {
          if (o[this.name]) {
              if (!o[this.name].push) {
                  o[this.name] = [ o[this.name] ];
              }
              o[this.name].push(this.value || '');
          } else {
              o[this.name] = this.value || '';
          }
      });
      return o;
    }

  })
</script>
</html>